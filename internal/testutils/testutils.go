//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_b "crypto/md5";_eb "encoding/hex";_f "errors";_bb "fmt";_a "github.com/doraemonkeys/unipdf/v3/common";_ee "github.com/doraemonkeys/unipdf/v3/core";_gb "image";_e "image/png";_dc "io";_gfe "os";_gg "os/exec";_d "path/filepath";_gf "strings";
_g "testing";);func CompareImages (img1 ,img2 _gb .Image )(bool ,error ){_fe :=img1 .Bounds ();_gbb :=0;for _ec :=0;_ec < _fe .Size ().X ;_ec ++{for _ffg :=0;_ffg < _fe .Size ().Y ;_ffg ++{_dcf ,_fc ,_bbb ,_ :=img1 .At (_ec ,_ffg ).RGBA ();_dg ,_ab ,_be ,_ :=img2 .At (_ec ,_ffg ).RGBA ();
if _dcf !=_dg ||_fc !=_ab ||_bbb !=_be {_gbb ++;};};};_cgb :=float64 (_gbb )/float64 (_fe .Dx ()*_fe .Dy ());if _cgb > 0.0001{_bb .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_cgb ,_gbb );
return false ,nil ;};return true ,nil ;};func CompareDictionariesDeep (d1 ,d2 *_ee .PdfObjectDictionary )bool {if len (d1 .Keys ())!=len (d2 .Keys ()){_a .Log .Debug ("\u0044\u0069\u0063\u0074\u0020\u0065\u006e\u0074\u0072\u0069\u0065\u0073\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",len (d1 .Keys ()),len (d2 .Keys ()));
_a .Log .Debug ("\u0057\u0061s\u0020\u0027\u0025s\u0027\u0020\u0076\u0073\u0020\u0027\u0025\u0073\u0027",d1 .WriteString (),d2 .WriteString ());return false ;};for _ ,_ae :=range d1 .Keys (){if _ae =="\u0050\u0061\u0072\u0065\u006e\u0074"{continue ;};_beb :=_ee .TraceToDirectObject (d1 .Get (_ae ));
_fg :=_ee .TraceToDirectObject (d2 .Get (_ae ));if _beb ==nil {_a .Log .Debug ("\u00761\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};if _fg ==nil {_a .Log .Debug ("\u00762\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};switch _dfe :=_beb .(type ){case *_ee .PdfObjectDictionary :_ac ,_eeb :=_fg .(*_ee .PdfObjectDictionary );
if !_eeb {_a .Log .Debug ("\u0054\u0079\u0070\u0065 m\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0020\u0025\u0054\u0020\u0076\u0073\u0020%\u0054",_beb ,_fg );return false ;};if !CompareDictionariesDeep (_dfe ,_ac ){return false ;};continue ;case *_ee .PdfObjectArray :_cfe ,_gd :=_fg .(*_ee .PdfObjectArray );
if !_gd {_a .Log .Debug ("\u00762\u0020n\u006f\u0074\u0020\u0061\u006e\u0020\u0061\u0072\u0072\u0061\u0079");return false ;};if _dfe .Len ()!=_cfe .Len (){_a .Log .Debug ("\u0061\u0072\u0072\u0061\u0079\u0020\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",_dfe .Len (),_cfe .Len ());
return false ;};for _gbf :=0;_gbf < _dfe .Len ();_gbf ++{_ace :=_ee .TraceToDirectObject (_dfe .Get (_gbf ));_fcb :=_ee .TraceToDirectObject (_cfe .Get (_gbf ));if _fef ,_fcc :=_ace .(*_ee .PdfObjectDictionary );_fcc {_ggd ,_fbdc :=_fcb .(*_ee .PdfObjectDictionary );
if !_fbdc {return false ;};if !CompareDictionariesDeep (_fef ,_ggd ){return false ;};}else {if _ace .WriteString ()!=_fcb .WriteString (){_a .Log .Debug ("M\u0069\u0073\u006d\u0061tc\u0068 \u0027\u0025\u0073\u0027\u0020!\u003d\u0020\u0027\u0025\u0073\u0027",_ace .WriteString (),_fcb .WriteString ());
return false ;};};};continue ;};if _beb .String ()!=_fg .String (){_a .Log .Debug ("\u006b\u0065y\u003d\u0025\u0073\u0020\u004d\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0021\u0020\u0027\u0025\u0073\u0027\u0020\u0021\u003d\u0020'%\u0073\u0027",_ae ,_beb .String (),_fg .String ());
_a .Log .Debug ("\u0046o\u0072 \u0027\u0025\u0054\u0027\u0020\u002d\u0020\u0027\u0025\u0054\u0027",_beb ,_fg );_a .Log .Debug ("\u0046\u006f\u0072\u0020\u0027\u0025\u002b\u0076\u0027\u0020\u002d\u0020'\u0025\u002b\u0076\u0027",_beb ,_fg );return false ;
};};return true ;};func RunRenderTest (t *_g .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ){_dfd :=_gf .TrimSuffix (_d .Base (pdfPath ),_d .Ext (pdfPath ));t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_gbg *_g .T ){_ge :=_d .Join (outputDir ,_dfd );
_bec :=_ge +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _eg :=RenderPDFToPNGs (pdfPath ,0,_bec );_eg !=nil {_gbg .Skip (_eg );};for _gbbe :=1;true ;_gbbe ++{_fd :=_bb .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_ge ,_gbbe );_geg :=_d .Join (baselineRenderPath ,_bb .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_dfd ,_gbbe ));
if _ ,_abe :=_gfe .Stat (_fd );_abe !=nil {break ;};_gbg .Logf ("\u0025\u0073",_geg );if saveBaseline {_gbg .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_fd ,_geg );_bbf :=CopyFile (_fd ,_geg );if _bbf !=nil {_gbg .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_geg ,_bbf );
};continue ;};_gbg .Run (_bb .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_gbbe ),func (_gbe *_g .T ){_gbe .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_fd ,_geg );_ddg ,_dfc :=ComparePNGFiles (_fd ,_geg );
if _gfe .IsNotExist (_dfc ){_gbe .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_ddg {_gbe .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_ga ,_gfg :=HashFile (file1 );if _gfg !=nil {return false ,_gfg ;};_ce ,_gfg :=HashFile (file2 );if _gfg !=nil {return false ,_gfg ;};if _ga ==_ce {return true ,nil ;};_ad ,_gfg :=ReadPNG (file1 );
if _gfg !=nil {return false ,_gfg ;};_gac ,_gfg :=ReadPNG (file2 );if _gfg !=nil {return false ,_gfg ;};if _ad .Bounds ()!=_gac .Bounds (){return false ,nil ;};return CompareImages (_ad ,_gac );};func ReadPNG (file string )(_gb .Image ,error ){_ff ,_ddf :=_gfe .Open (file );
if _ddf !=nil {return nil ,_ddf ;};defer _ff .Close ();return _e .Decode (_ff );};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;};if _ ,_fbd :=_gg .LookPath ("\u0067\u0073");_fbd !=nil {return ErrRenderNotSupported ;
};return _gg .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_bb .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();};func _ca (_ecc _ee .PdfObject ,_bed map[int64 ]_ee .PdfObject )error {switch _eaf :=_ecc .(type ){case *_ee .PdfIndirectObject :_gaa :=_eaf ;
_ca (_gaa .PdfObject ,_bed );case *_ee .PdfObjectDictionary :_cad :=_eaf ;for _ ,_bfb :=range _cad .Keys (){_bbbc :=_cad .Get (_bfb );if _dge ,_cbe :=_bbbc .(*_ee .PdfObjectReference );_cbe {_cc ,_ega :=_bed [_dge .ObjectNumber ];if !_ega {return _f .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_cad .Set (_bfb ,_cc );}else {_ca (_bbbc ,_bed );};};case *_ee .PdfObjectArray :_gef :=_eaf ;for _ade ,_dbd :=range _gef .Elements (){if _bc ,_dff :=_dbd .(*_ee .PdfObjectReference );_dff {_fde ,_dec :=_bed [_bc .ObjectNumber ];if !_dec {return _f .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_gef .Set (_ade ,_fde );}else {_ca (_dbd ,_bed );};};};return nil ;};var (ErrRenderNotSupported =_f .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
);func CopyFile (src ,dst string )error {_cg ,_dd :=_gfe .Open (src );if _dd !=nil {return _dd ;};defer _cg .Close ();_fb ,_dd :=_gfe .Create (dst );if _dd !=nil {return _dd ;};defer _fb .Close ();_ ,_dd =_dc .Copy (_fb ,_cg );return _dd ;};func ParseIndirectObjects (rawpdf string )(map[int64 ]_ee .PdfObject ,error ){_bd :=_ee .NewParserFromString (rawpdf );
_eba :=map[int64 ]_ee .PdfObject {};for {_db ,_ebg :=_bd .ParseIndirectObject ();if _ebg !=nil {if _ebg ==_dc .EOF {break ;};return nil ,_ebg ;};switch _ebb :=_db .(type ){case *_ee .PdfIndirectObject :_eba [_ebb .ObjectNumber ]=_db ;case *_ee .PdfObjectStream :_eba [_ebb .ObjectNumber ]=_db ;
};};for _ ,_cf :=range _eba {_ca (_cf ,_eba );};return _eba ,nil ;};func HashFile (file string )(string ,error ){_ebf ,_cb :=_gfe .Open (file );if _cb !=nil {return "",_cb ;};defer _ebf .Close ();_df :=_b .New ();if _ ,_cb =_dc .Copy (_df ,_ebf );_cb !=nil {return "",_cb ;
};return _eb .EncodeToString (_df .Sum (nil )),nil ;};